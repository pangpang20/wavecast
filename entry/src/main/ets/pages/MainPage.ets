import { Podcast } from '../model/Podcast';
import { Episode, DownloadStatus } from '../model/Episode';
import { PodcastService } from '../service/PodcastService';
import { DatabaseService } from '../service/DatabaseService';
import { PlayerService } from '../service/PlayerService';
import { DownloadService } from '../service/DownloadService';
import { UIUtils, ToastOptions, RouteParams } from '../common/UIUtils';

@Entry
@Component
struct MainPage {
  @State currentTabIndex: number = 0;
  @State podcasts: Podcast[] = [];
  @State isLoading: boolean = false;
  @State hasCurrentEpisode: boolean = false;
  @State currentEpisode: Episode | null = null;
  @State isPlaying: boolean = false;
  @State playProgress: number = 0;
  @State currentPlayTime: number = 0;  // å½“å‰æ’­æ”¾æ—¶é—´ï¼ˆç§’ï¼‰
  @State totalDuration: number = 0;  // æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  @State sleepTimerRemaining: number = 0;  // ç¡çœ å®šæ—¶å™¨å‰©ä½™ç§’æ•°
  @State marqueeText: string = '';  // è·‘é©¬ç¯æ–‡æœ¬
  @State downloadingEpisodes: Episode[] = [];
  @State downloadedEpisodes: Episode[] = [];
  @State allEpisodes: Episode[] = [];  // æ‰€æœ‰å•é›†
  @State episodesPage: number = 1;  // å•é›†å½“å‰é¡µ
  @State episodesPageSize: number = 20;  // æ¯é¡µæ•°é‡
  @State episodesHasMore: boolean = false;  // æ˜¯å¦è¿˜æœ‰æ›´å¤š
  @State episodeSearchKeyword: string = '';  // å•é›†æœç´¢å…³é”®è¯
  @State filteredEpisodes: Episode[] = [];  // è¿‡æ»¤/æœç´¢ç»“æœ
  @State searchTotal: number = 0;  // æœç´¢ç»“æœæ€»æ•°
  @State searchPage: number = 1;  // æœç´¢ç»“æœå½“å‰é¡µ
  @State isSearching: boolean = false;  // æ˜¯å¦æ­£åœ¨æœç´¢ï¼ˆé¦–æ¬¡ï¼‰
  @State isLoadingMore: boolean = false;  // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š
  @State searchHasMore: boolean = false;  // æœç´¢ç»“æœæ˜¯å¦è¿˜æœ‰æ›´å¤š
  @State queueEpisodes: Episode[] = [];  // å¾…å¬é˜Ÿåˆ—
  @State isDownloadEditMode: boolean = false;  // ä¸‹è½½ç®¡ç†ç¼–è¾‘æ¨¡å¼
  @State selectedDownloadIds: Set<string> = new Set();  // å·²é€‰ä¸­çš„ä¸‹è½½é¡¹ID
  private playerService: PlayerService = PlayerService.getInstance();
  private dbService: DatabaseService = DatabaseService.getInstance();
  private downloadUpdateTimer: number = -1;
  private playUpdateTimer: number = -1;
  private subscriptionUpdateTimer: number = -1;

  aboutToAppear() {
    this.loadSubscriptions();
    this.loadAllEpisodes();
    this.loadQueue();
    this.checkCurrentEpisode();
    this.loadDownloads();
    this.startPlayUpdateTimer();
    
    // é»˜è®¤åœ¨è®¢é˜… Tabï¼Œå¯åŠ¨è®¢é˜…åˆ·æ–°å®šæ—¶å™¨
    if (this.currentTabIndex === 0) {
      this.startSubscriptionUpdateTimer();
    }
    
    // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–
    this.playerService.addEventListener('stateChange', () => {
      this.checkCurrentEpisode();
    });
  }

  aboutToDisappear() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
    if (this.playUpdateTimer !== -1) {
      clearInterval(this.playUpdateTimer);
      this.playUpdateTimer = -1;
    }
    if (this.subscriptionUpdateTimer !== -1) {
      clearInterval(this.subscriptionUpdateTimer);
      this.subscriptionUpdateTimer = -1;
    }
  }

  /**
   * å¯åŠ¨æ’­æ”¾çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
   */
  startPlayUpdateTimer() {
    this.playUpdateTimer = setInterval(() => {
      this.checkCurrentEpisode();
    }, 500);
  }

  onPageShow() {
    // é¡µé¢é€šè¿‡è·¯ç”±è¿”å›æ—¶åˆ·æ–°åˆ—è¡¨
    this.loadSubscriptions();
    this.loadAllEpisodes();
    this.loadQueue();
    this.checkCurrentEpisode();
    this.loadDownloads();
  }

  /**
   * åŠ è½½ä¸‹è½½åˆ—è¡¨
   */
  async loadDownloads() {
    try {
      const db = DatabaseService.getInstance();
      const downloadService = DownloadService.getInstance();
      const allEpisodes = await db.getAllEpisodes();
      
      // è·å–æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡ï¼ˆä»å†…å­˜ä¸­è·å–å®æ—¶è¿›åº¦ï¼‰
      const activeTasks = downloadService.getAllDownloadTasks();
      const activeTaskMap = new Map(activeTasks.map(t => [t.episode.id, t.episode]));
      
      // å¯¹äºæ­£åœ¨ä¸‹è½½çš„ï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜ä¸­çš„å®æ—¶è¿›åº¦
      this.downloadingEpisodes = allEpisodes
        .filter(e => Number(e.downloadStatus) === DownloadStatus.DOWNLOADING)
        .map(e => {
          // å¦‚æœåœ¨æ´»åŠ¨ä¸‹è½½ä¸­ï¼Œä½¿ç”¨å†…å­˜ä¸­çš„è¿›åº¦
          const activeEpisode = activeTaskMap.get(e.id);
          if (activeEpisode) {
            e.downloadProgress = activeEpisode.downloadProgress;
          }
          return e;
        });
      
      this.downloadedEpisodes = allEpisodes.filter(e => {
        const status = Number(e.downloadStatus);
        return status === DownloadStatus.DOWNLOADED;
      });
      
      console.info(`[MainPage] Downloads - Downloading: ${this.downloadingEpisodes.length}, Downloaded: ${this.downloadedEpisodes.length}`);
    } catch (error) {
      console.error('[MainPage] Failed to load downloads:', error);
    }
  }

  /**
   * å¼€å§‹ä¸‹è½½æ›´æ–°å®šæ—¶å™¨
   */
  startDownloadUpdateTimer() {
    if (this.downloadUpdateTimer === -1) {
      this.downloadUpdateTimer = setInterval(() => {
        this.loadDownloads();
      }, 1000);
    }
  }

  /**
   * åœæ­¢ä¸‹è½½æ›´æ–°å®šæ—¶å™¨
   */
  stopDownloadUpdateTimer() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
  }

  /**
   * å¼€å§‹è®¢é˜…æ›´æ–°å®šæ—¶å™¨ - æ¯5ç§’åˆ·æ–°é›†æ•°
   */
  startSubscriptionUpdateTimer() {
    if (this.subscriptionUpdateTimer === -1) {
      this.subscriptionUpdateTimer = setInterval(() => {
        this.loadSubscriptions();
        console.info('[MainPage] Subscription list refreshed');
      }, 5000);
    }
  }

  /**
   * åœæ­¢è®¢é˜…æ›´æ–°å®šæ—¶å™¨
   */
  stopSubscriptionUpdateTimer() {
    if (this.subscriptionUpdateTimer !== -1) {
      clearInterval(this.subscriptionUpdateTimer);
      this.subscriptionUpdateTimer = -1;
    }
  }

  /**
   * åŠ è½½æ‰€æœ‰å•é›†ï¼ˆå€’åºæ’åˆ—ï¼Œåˆ†é¡µï¼‰
   */
  async loadAllEpisodes() {
    try {
      const allEps = await this.dbService.getAllEpisodes();
      // æŒ‰pubDateå€’åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
      allEps.sort((a, b) => (b.pubDate || 0) - (a.pubDate || 0));
      // åˆ†é¡µæ˜¾ç¤º
      const showCount = this.episodesPage * this.episodesPageSize;
      this.allEpisodes = allEps.slice(0, showCount);
      this.episodesHasMore = allEps.length > showCount;
      
      // åº”ç”¨æœç´¢è¿‡æ»¤
      this.filterEpisodes();
      
      console.info(`[MainPage] Loaded ${this.allEpisodes.length}/${allEps.length} episodes (page ${this.episodesPage})`);
    } catch (error) {
      console.error('[MainPage] Failed to load episodes:', error);
    }
  }

  /**
   * åŠ è½½æ›´å¤šå•é›†
   */
  async loadMoreEpisodes() {
    this.episodesPage++;
    await this.loadAllEpisodes();
  }

  /**
   * è¿‡æ»¤å•é›†åˆ—è¡¨ï¼ˆæ— æœç´¢å…³é”®è¯æ—¶ï¼‰
   */
  filterEpisodes() {
    // å¦‚æœæœ‰æœç´¢å…³é”®è¯ä¸”æœ‰æœç´¢ç»“æœï¼Œä¿æŒæœç´¢ç»“æœä¸å˜
    if (this.episodeSearchKeyword && this.episodeSearchKeyword.trim() !== '' && this.searchTotal > 0) {
      return;
    }
    this.filteredEpisodes = this.allEpisodes;
  }

  /**
   * æœç´¢å•é›†ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰
   */
  async searchEpisodes() {
    if (!this.episodeSearchKeyword || this.episodeSearchKeyword.trim() === '') {
      return;
    }
    
    this.isSearching = true;
    try {
      const result = await this.dbService.searchEpisodes(
        this.episodeSearchKeyword.trim(),
        0,
        this.episodesPageSize
      );
      this.filteredEpisodes = result.episodes;
      this.searchTotal = result.total;
      this.searchPage = 1;
      this.searchHasMore = result.episodes.length < result.total;
      console.info(`[MainPage] Search: ${result.episodes.length}/${result.total}`);
    } catch (error) {
      console.error('[MainPage] Search failed:', error);
    } finally {
      this.isSearching = false;
    }
  }

  /**
   * åŠ è½½æ›´å¤šæœç´¢ç»“æœ
   */
  async loadMoreSearchResults() {
    if (!this.searchHasMore || this.isLoadingMore) return;
    
    this.isLoadingMore = true;
    try {
      const offset = this.searchPage * this.episodesPageSize;
      const result = await this.dbService.searchEpisodes(
        this.episodeSearchKeyword.trim(),
        offset,
        this.episodesPageSize
      );
      this.filteredEpisodes = this.filteredEpisodes.concat(result.episodes);
      this.searchPage++;
      this.searchHasMore = this.filteredEpisodes.length < this.searchTotal;
      console.info(`[MainPage] Load more search: ${this.filteredEpisodes.length}/${this.searchTotal}`);
    } catch (error) {
      console.error('[MainPage] Load more search failed:', error);
    } finally {
      this.isLoadingMore = false;
    }
  }

  /**
   * å¤„ç†æœç´¢è¾“å…¥å˜åŒ–
   */
  onEpisodeSearchChange(value: string) {
    this.episodeSearchKeyword = value;
    if (!value || value.trim() === '') {
      // æ¸…ç©ºæœç´¢ï¼Œæ˜¾ç¤ºå…¨éƒ¨å•é›†
      this.searchHasMore = false;
      this.searchTotal = 0;
      this.filterEpisodes();
    }
  }

  /**
   * æ‰§è¡Œæœç´¢ï¼ˆç”¨æˆ·ç‚¹å‡»æœç´¢æˆ–å›è½¦ï¼‰
   */
  onEpisodeSearchSubmit() {
    if (this.episodeSearchKeyword && this.episodeSearchKeyword.trim() !== '') {
      this.searchEpisodes();
    }
  }

  /**
   * åŠ è½½å¾…å¬é˜Ÿåˆ—
   */
  async loadQueue() {
    try {
      this.queueEpisodes = await this.dbService.getQueueEpisodes();
      console.info(`[MainPage] Loaded ${this.queueEpisodes.length} queue items`);
    } catch (error) {
      console.error('[MainPage] Failed to load queue:', error);
    }
  }

  /**
   * æ·»åŠ åˆ°å¾…å¬é˜Ÿåˆ—
   */
  async addToQueue(episode: Episode) {
    try {
      await this.dbService.addToQueue(episode.id);
      await this.loadQueue();
      console.info(`[MainPage] Added to queue: ${episode.title}`);
      UIUtils.showToast(new ToastOptions('å·²æ·»åŠ åˆ°é˜Ÿåˆ—', 2000));
    } catch (error) {
      console.error('[MainPage] Failed to add to queue:', error);
      UIUtils.showToast(new ToastOptions('æ·»åŠ å¤±è´¥', 2000));
    }
  }

  /**
   * ä»å¾…å¬é˜Ÿåˆ—ç§»é™¤
   */
  async removeFromQueue(episode: Episode) {
    try {
      await this.dbService.removeFromQueue(episode.id);
      await this.loadQueue();
      console.info(`[MainPage] Removed from queue: ${episode.title}`);
    } catch (error) {
      console.error('[MainPage] Failed to remove from queue:', error);
    }
  }

  /**
   * åŠ è½½è®¢é˜…åˆ—è¡¨
   */
  async loadSubscriptions() {
    this.isLoading = true;
    try {
      this.podcasts = await PodcastService.getInstance().getSubscribedPodcasts();
    } catch (error) {
      console.error('Failed to load subscriptions:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ’­æ”¾çš„å•é›†
   */
  checkCurrentEpisode() {
    this.currentEpisode = this.playerService.getCurrentEpisode();
    this.hasCurrentEpisode = this.currentEpisode !== null;
    this.isPlaying = this.playerService.getState() === 'playing';
    
    if (this.currentEpisode) {
      const position = this.playerService.getCurrentPosition();
      const duration = this.playerService.getDuration();
      this.playProgress = duration > 0 ? (position / duration) * 100 : 0;
      
      // æ›´æ–°æ’­æ”¾æ—¶é—´
      this.currentPlayTime = position;
      this.totalDuration = duration;
      
      // æ›´æ–°è·‘é©¬ç¯æ–‡æœ¬ï¼Œä½¿ç”¨è±å½¢ç¬¦å·åˆ†éš”ï¼Œç¡®ä¿å¯è§æ€§
      this.marqueeText = `${this.currentEpisode.title}     â—†     `;
    }
    
    // æ›´æ–°ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
    this.sleepTimerRemaining = this.playerService.getSleepTimerRemaining();
  }

  /**
   * æ‰“å¼€æ’­æ”¾é¡µé¢
   */
  openPlayerPage() {
    const currentEpisode = this.playerService.getCurrentEpisode();
    if (currentEpisode) {
      const params = new RouteParams();
      params.episodeId = currentEpisode.id;
      UIUtils.pushUrl('pages/PlayerPage', params);
    }
  }

  /**
   * æ’­æ”¾ä¸‹ä¸€ä¸ªå•é›†
   */
  async playNextEpisode() {
    try {
      // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
      if (this.queueEpisodes.length === 0) {
        UIUtils.showToast(new ToastOptions('é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯·æ·»åŠ å•é›†åˆ°é˜Ÿåˆ—', 2000));
        return;
      }

      // è·å–é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå•é›†
      const nextEpisode = this.queueEpisodes[0];
      console.info(`[MainPage] Playing next episode: ${nextEpisode.title}`);
      
      // æ’­æ”¾ä¸‹ä¸€ä¸ª
      await this.playerService.playEpisode(nextEpisode);
      
      // æ›´æ–° mini æ’­æ”¾å™¨çŠ¶æ€
      this.checkCurrentEpisode();
      
      // ä»é˜Ÿåˆ—ä¸­ç§»é™¤
      await this.removeFromQueue(nextEpisode);
      
      UIUtils.showToast(new ToastOptions(`æ­£åœ¨æ’­æ”¾ï¼š${nextEpisode.title}`, 2000));
    } catch (error) {
      console.error('[MainPage] Failed to play next episode:', error);
      UIUtils.showToast(new ToastOptions('æ’­æ”¾å¤±è´¥', 2000));
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildHeader();

      // Tabé¡µç­¾
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildSubscriptionTab();
        }.tabBar(this.TabBarBuilder('è®¢é˜…', 0))

        TabContent() {
          this.buildEpisodesTab();
        }.tabBar(this.TabBarBuilder('å•é›†', 1))

        TabContent() {
          this.buildQueueTab();
        }.tabBar(this.TabBarBuilder('é˜Ÿåˆ—', 2))

        TabContent() {
          this.buildDownloadsTab();
        }.tabBar(this.TabBarBuilder('ä¸‹è½½', 3))
      }
      .barMode(BarMode.Fixed)
      .barHeight(56)
      .barBackgroundColor($r('app.color.background_card'))
      .onChange((index: number) => {
        this.currentTabIndex = index;
        // åˆ‡æ¢åˆ°è®¢é˜… tab æ—¶å¯åŠ¨è®¢é˜…åˆ·æ–°å®šæ—¶å™¨
        if (index === 0) {
          this.loadSubscriptions();
          this.startSubscriptionUpdateTimer();
        } else {
          this.stopSubscriptionUpdateTimer();
        }
        // åˆ‡æ¢åˆ°ä¸‹è½½ tab æ—¶å¯åŠ¨å®šæ—¶åˆ·æ–°
        if (index === 3) {
          this.loadDownloads();
          this.startDownloadUpdateTimer();
        } else {
          this.stopDownloadUpdateTimer();
        }
      })
      .layoutWeight(1)

      // è¿·ä½ æ’­æ”¾å™¨ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰
      if (this.hasCurrentEpisode && this.currentEpisode) {
        this.buildMiniPlayer();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }

  /**
   * æ„å»ºå¤´éƒ¨
   */
  @Builder
  TabBarBuilder(title: string, index: number) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(this.currentTabIndex === index ? FontWeight.Bold : FontWeight.Normal)
        .fontColor(this.currentTabIndex === index ? $r('app.color.primary') : $r('app.color.text_secondary'))
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æ„å»ºå¤´éƒ¨
   */
  @Builder
  buildHeader() {
    Row() {
      Text('WaveCast')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))

      Blank()

      // æœç´¢æŒ‰é’®
      Button() {
        Text('ğŸ”')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('[MainPage] Search clicked');
        // è·³è½¬åˆ°æœç´¢é¡µé¢
        UIUtils.pushUrl('pages/SearchPage');
      })

      // è®¾ç½®æŒ‰é’®
      Button() {
        Text('âš™ï¸')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('[MainPage] Settings clicked');
        // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        UIUtils.pushUrl('pages/SettingsPage');
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.background_card'))
  }

  /**
   * è®¢é˜…é¡µç­¾
   */
  @Builder
  buildSubscriptionTab() {
    Column() {
      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
      } else if (this.podcasts.length === 0) {
        this.buildEmptyView('æš‚æ— è®¢é˜…', 'ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ’­å®¢');
      } else {
        List({ space: 12 }) {
          ForEach(this.podcasts, (podcast: Podcast) => {
            ListItem() {
              this.buildPodcastItem(podcast);
            }
          }, (podcast: Podcast) => podcast.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å•é›†é¡µç­¾
   */
  @Builder
  buildEpisodesTab() {
    Column() {
      // æœç´¢æ¡†
      Row() {
        Search({ placeholder: 'æœç´¢å•é›†æ ‡é¢˜æˆ–æè¿°', value: this.episodeSearchKeyword })
          .width('100%')
          .height(40)
          .backgroundColor($r('app.color.background_card'))
          .onChange((value: string) => {
            this.onEpisodeSearchChange(value);
          })
          .onSubmit(() => {
            this.onEpisodeSearchSubmit();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })

      // æœç´¢ç»“æœæç¤º
      if (this.episodeSearchKeyword && this.searchTotal > 0) {
        Text(`æ‰¾åˆ° ${this.searchTotal} ä¸ªå•é›†ï¼ˆåŒ¹é…æ ‡é¢˜æˆ–ç®€ä»‹ï¼‰`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .width('100%')
          .padding({ left: 16, bottom: 8 })
      }

      if (this.isSearching) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 50 })
      } else if (this.allEpisodes.length === 0 && !this.episodeSearchKeyword) {
        this.buildEmptyView('æš‚æ— å•é›†', 'è®¢é˜…æ’­å®¢åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ');
      } else if (this.filteredEpisodes.length === 0 && this.episodeSearchKeyword) {
        this.buildEmptyView('æœªæ‰¾åˆ°åŒ¹é…çš„å•é›†', 'å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯');
      } else {
        List({ space: 8 }) {
          ForEach(this.filteredEpisodes, (episode: Episode) => {
            ListItem() {
              this.buildEpisodeItemWithDate(episode);
            }
          }, (episode: Episode) => episode.id)

          // åŠ è½½æ›´å¤šæŒ‰é’®
          if ((this.episodesHasMore && !this.episodeSearchKeyword) || this.searchHasMore) {
            ListItem() {
              Row() {
                if (this.isLoadingMore) {
                  LoadingProgress()
                    .width(24)
                    .height(24)
                    .margin({ right: 8 })
                  Text('åŠ è½½ä¸­...')
                    .fontSize(14)
                    .fontColor($r('app.color.text_secondary'))
                } else {
                  Button('åŠ è½½æ›´å¤š')
                    .width('100%')
                    .height(44)
                    .fontSize(14)
                    .backgroundColor($r('app.color.primary'))
                    .fontColor($r('app.color.text_on_primary'))
                    .onClick(() => {
                      if (this.episodeSearchKeyword) {
                        console.info('[MainPage] Load more search results');
                        this.loadMoreSearchResults();
                      } else {
                        console.info('[MainPage] Load more episodes');
                        this.loadMoreEpisodes();
                      }
                    })
                }
              }
              .width('100%')
              .height(44)
              .justifyContent(FlexAlign.Center)
            }
          }
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å•é›†é¡¹ï¼ˆå¸¦æ—¥æœŸï¼‰
   */
  @Builder
  buildEpisodeItemWithDate(episode: Episode) {
    Row() {
      // å°é¢å›¾
      Image(episode.imageUrl)
        .width(56)
        .height(56)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // å•é›†ä¿¡æ¯
      Column() {
        Text(episode.title)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(episode.getFormattedPubDate())
            .fontSize(12)
            .fontColor($r('app.color.primary'))

          Text(` Â· ${episode.getFormattedDuration()}`)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 12 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.background_card'))
    .borderRadius(8)
    .onClick(() => {
      console.info(`[MainPage] Episode: ${episode.title}`);
      const params = new RouteParams();
      params.episodeId = episode.id;
      UIUtils.pushUrl('pages/EpisodeDetailPage', params);
    })
  }

  /**
   * é˜Ÿåˆ—é¡µç­¾
   */
  @Builder
  buildQueueTab() {
    Column() {
      if (this.queueEpisodes.length === 0) {
        this.buildEmptyView('æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º', 'æ·»åŠ å•é›†åˆ°é˜Ÿåˆ—');
      } else {
        // é˜Ÿåˆ—æ“ä½œæ 
        Row() {
          Text(`å¾…å¬ ${this.queueEpisodes.length} é›†`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))

          Blank()

          Button('æ¸…ç©ºé˜Ÿåˆ—')
            .height(32)
            .fontSize(12)
            .backgroundColor($r('app.color.accent_red'))
            .fontColor($r('app.color.text_on_primary'))
            .onClick(async () => {
              console.info('[MainPage] Clear queue');
              await this.dbService.clearQueue();
              await this.loadQueue();
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

        List({ space: 8 }) {
          ForEach(this.queueEpisodes, (episode: Episode, index: number) => {
            ListItem() {
              this.buildQueueItem(episode, index);
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ä¸‹è½½é¡µç­¾
   */
  @Builder
  buildDownloadsTab() {
    Column() {
      // ä¸‹è½½ä¸­éƒ¨åˆ†
      if (this.downloadingEpisodes.length > 0) {
        Text('ä¸‹è½½ä¸­')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 8 })
        
        List({ space: 8 }) {
          ForEach(this.downloadingEpisodes, (episode: Episode) => {
            ListItem() {
              Column() {
                Row() {
                  Text(episode.title)
                    .fontSize(14)
                    .layoutWeight(1)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(`${episode.downloadProgress}%`)
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                }
                .width('100%')

                Progress({ value: episode.downloadProgress, total: 100, type: ProgressType.Linear })
                  .width('100%')
                  .margin({ top: 8 })

                Row() {
                  // æš‚åœ/ç»§ç»­æŒ‰é’®
                  Button(DownloadService.getInstance().isDownloadPaused(episode.id) ? 'ç»§ç»­' : 'æš‚åœ')
                    .height(28)
                    .fontSize(12)
                    .backgroundColor(DownloadService.getInstance().isDownloadPaused(episode.id) ? $r('app.color.accent_green') : $r('app.color.accent_orange'))
                    .fontColor($r('app.color.text_on_primary'))
                    .onClick(async () => {
                      const downloadService = DownloadService.getInstance();
                      if (downloadService.isDownloadPaused(episode.id)) {
                        await downloadService.resumeDownload(episode.id);
                      } else {
                        await downloadService.pauseDownload(episode.id);
                      }
                      this.loadDownloads();
                    })

                  // å–æ¶ˆæŒ‰é’®
                  Button('å–æ¶ˆ')
                    .height(28)
                    .fontSize(12)
                    .backgroundColor($r('app.color.accent_red'))
                    .fontColor($r('app.color.text_on_primary'))
                    .margin({ left: 8 })
                    .onClick(async () => {
                      await DownloadService.getInstance().cancelDownload(episode.id);
                      this.loadDownloads();
                    })
                }
                .width('100%')
                .margin({ top: 8 })
                .justifyContent(FlexAlign.End)
              }
              .width('100%')
              .padding(12)
              .backgroundColor($r('app.color.background_card'))
              .borderRadius(8)
            }
          }, (episode: Episode) => `${episode.id}_${episode.downloadProgress}`)
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }

      // å·²ä¸‹è½½éƒ¨åˆ†
      if (this.downloadedEpisodes.length > 0) {
        Row() {
          Text('å·²ä¸‹è½½')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .layoutWeight(1)

          if (this.isDownloadEditMode) {
            Text(this.selectedDownloadIds.size === this.downloadedEpisodes.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰')
              .fontSize(14)
              .fontColor($r('app.color.primary'))
              .onClick(() => {
                if (this.selectedDownloadIds.size === this.downloadedEpisodes.length) {
                  this.selectedDownloadIds = new Set();
                } else {
                  this.selectedDownloadIds = new Set(this.downloadedEpisodes.map(e => e.id));
                }
              })

            Text('å®Œæˆ')
              .fontSize(14)
              .fontColor($r('app.color.primary'))
              .margin({ left: 16 })
              .onClick(() => {
                this.isDownloadEditMode = false;
                this.selectedDownloadIds = new Set();
              })
          } else {
            Text('ç®¡ç†')
              .fontSize(14)
              .fontColor($r('app.color.primary'))
              .onClick(() => {
                this.isDownloadEditMode = true;
              })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

        // æ‰¹é‡æ“ä½œæ 
        if (this.isDownloadEditMode && this.selectedDownloadIds.size > 0) {
          Row() {
            Text(`å·²é€‰æ‹© ${this.selectedDownloadIds.size} é¡¹`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .layoutWeight(1)

            Button('+ å¾…å¬')
              .height(32)
              .fontSize(12)
              .backgroundColor($r('app.color.accent_green'))
              .fontColor($r('app.color.text_on_primary'))
              .onClick(async () => {
                for (const id of this.selectedDownloadIds) {
                  await this.dbService.addToQueue(id);
                }
                UIUtils.showToast(new ToastOptions(`å·²æ·»åŠ  ${this.selectedDownloadIds.size} ä¸ªå•é›†åˆ°å¾…å¬é˜Ÿåˆ—`, 2000));
                this.selectedDownloadIds = new Set();
                this.loadQueue();
              })

            Button('åˆ é™¤')
              .height(32)
              .fontSize(12)
              .backgroundColor($r('app.color.accent_red'))
              .fontColor($r('app.color.text_on_primary'))
              .margin({ left: 8 })
              .onClick(async () => {
                const downloadService = DownloadService.getInstance();
                for (const id of this.selectedDownloadIds) {
                  const episode = this.downloadedEpisodes.find(e => e.id === id);
                  if (episode) {
                    await downloadService.deleteDownloadedFile(episode);
                  }
                }
                UIUtils.showToast(new ToastOptions(`å·²åˆ é™¤ ${this.selectedDownloadIds.size} ä¸ªä¸‹è½½`, 2000));
                this.selectedDownloadIds = new Set();
                this.loadDownloads();
              })
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
        }
        
        List({ space: 8 }) {
          ForEach(this.downloadedEpisodes, (episode: Episode) => {
            ListItem() {
              Column() {
                Row() {
                  // ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºé€‰æ‹©æ¡†
                  if (this.isDownloadEditMode) {
                    Checkbox()
                      .select(this.selectedDownloadIds.has(episode.id))
                      .onChange((checked: boolean) => {
                        if (checked) {
                          this.selectedDownloadIds.add(episode.id);
                        } else {
                          this.selectedDownloadIds.delete(episode.id);
                        }
                        // è§¦å‘ UI æ›´æ–°
                        this.selectedDownloadIds = new Set(this.selectedDownloadIds);
                      })
                      .margin({ right: 12 })
                  }

                  Column() {
                    Text(episode.title)
                      .fontSize(14)
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })

                    Text(episode.getFormattedFileSize())
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                      .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                }
                .width('100%')

                // éç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                if (!this.isDownloadEditMode) {
                  Row() {
                    Button('â–¶ æ’­æ”¾')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.primary'))
                      .fontColor($r('app.color.text_on_primary'))
                      .onClick(async () => {
                        console.info(`[MainPage] Play: ${episode.title}`);
                        await this.playerService.playEpisode(episode);
                        this.checkCurrentEpisode();
                      })

                    Button('+ å¾…å¬')
                      .height(32)
                      .fontSize(12)
                      .margin({ left: 8 })
                      .backgroundColor($r('app.color.accent_green'))
                      .fontColor($r('app.color.text_on_primary'))
                      .onClick(() => {
                        console.info(`[MainPage] Add to queue: ${episode.title}`);
                        this.addToQueue(episode);
                      })

                    Blank()

                    Button('åˆ é™¤')
                      .height(32)
                      .fontSize(12)
                      .backgroundColor($r('app.color.accent_red'))
                      .fontColor($r('app.color.text_on_primary'))
                      .onClick(() => {
                        console.info(`[MainPage] Delete: ${episode.title}`);
                        DownloadService.getInstance().deleteDownloadedFile(episode);
                        this.loadDownloads();
                      })
                  }
                  .width('100%')
                  .margin({ top: 8 })
                }
              }
              .width('100%')
              .padding(12)
              .backgroundColor($r('app.color.background_card'))
              .borderRadius(8)
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }

      // ç©ºçŠ¶æ€
      if (this.downloadingEpisodes.length === 0 && this.downloadedEpisodes.length === 0) {
        this.buildEmptyView('æš‚æ— ä¸‹è½½', 'ä¸‹è½½å•é›†ä»¥ä¾¿ç¦»çº¿æ”¶å¬');
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ’­å®¢é¡¹
   */
  @Builder
  buildPodcastItem(podcast: Podcast) {
    Row() {
      // æ’­å®¢å°é¢
      Image(podcast.imageUrl)
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // æ’­å®¢ä¿¡æ¯
      Column() {
        Text(podcast.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(podcast.author)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 4 })

        Text(`${podcast.episodeCount} é›†`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.background_card'))
    .borderRadius(8)
    .onClick(() => {
      console.info(`[MainPage] Podcast: ${podcast.title}`);
      // è·³è½¬åˆ°æ’­å®¢è¯¦æƒ…é¡µ
      const params = new RouteParams();
      params.podcastId = podcast.id;
      UIUtils.pushUrl('pages/PodcastDetailPage', params);
    })
  }

  /**
   * å•é›†é¡¹
   */
  @Builder
  buildEpisodeItem(episode: Episode) {
    Column() {
      Row() {
        // å°é¢å›¾
        Image(episode.imageUrl)
          .width(60)
          .height(60)
          .borderRadius(6)
          .objectFit(ImageFit.Cover)
          .alt($r('app.media.app_icon'))

        // å•é›†ä¿¡æ¯
        Column() {
          Text(episode.title)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row() {
            Text(episode.getFormattedDuration())
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))

            if (episode.downloadStatus === 2) {
              Text(' Â· å·²ä¸‹è½½')
                .fontSize(12)
                .fontColor($r('app.color.accent_green'))
            }
          }
          .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })
      }
      .width('100%')

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('â–¶ æ’­æ”¾')
          .height(28)
          .fontSize(11)
          .backgroundColor($r('app.color.primary'))
          .fontColor($r('app.color.text_on_primary'))
          .onClick(async () => {
            console.info(`[MainPage] Play: ${episode.title}`);
            await this.playerService.playEpisode(episode);
            this.checkCurrentEpisode();
          })

        Button('+ å¾…å¬')
          .height(28)
          .fontSize(11)
          .margin({ left: 8 })
          .backgroundColor($r('app.color.accent_green'))
          .fontColor($r('app.color.text_on_primary'))
          .onClick(() => {
            console.info(`[MainPage] Add to queue: ${episode.title}`);
            this.addToQueue(episode);
          })
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.background_card'))
    .borderRadius(8)
  }

  /**
   * é˜Ÿåˆ—é¡¹
   */
  @Builder
  buildQueueItem(episode: Episode, index: number) {
    Row() {
      // åºå·
      Text(`${index + 1}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.primary'))
        .width(28)
        .textAlign(TextAlign.Center)

      // å°é¢å›¾
      Image(episode.imageUrl)
        .width(46)
        .height(46)
        .borderRadius(6)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))
        .margin({ left: 4 })

      // å•é›†ä¿¡æ¯
      Column() {
        Text(episode.title)
          .fontSize(13)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(episode.getFormattedDuration())
          .fontSize(11)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 8, right: 8 })

      // æ“ä½œæŒ‰é’®
      Row() {
        // æ’­æ”¾æŒ‰é’®
        Button() {
          Text('â–¶')
            .fontSize(14)
            .fontColor($r('app.color.text_on_primary'))
        }
        .width(36)
        .height(36)
        .backgroundColor($r('app.color.primary'))
        .borderRadius(18)
        .flexShrink(0)
        .onClick(() => {
          console.info(`[MainPage] Queue play: ${episode.title}`);
          this.playerService.playEpisode(episode);
        })

        // åˆ é™¤æŒ‰é’®
        Button() {
          Text('ğŸ—‘')
            .fontSize(16)
            .fontColor($r('app.color.delete_button_text'))  // æ·±çº¢è‰²æ–‡å­—
        }
        .width(36)
        .height(36)
        .backgroundColor($r('app.color.delete_button_bg'))  // æ·¡çº¢è‰²èƒŒæ™¯
        .border({ width: 1.5, color: $r('app.color.delete_button_text'), radius: 18 })  // æ·±çº¢è‰²è¾¹æ¡†
        .margin({ left: 8 })
        .flexShrink(0)
        .onClick(() => {
          console.info(`[MainPage] Queue remove: ${episode.title}`);
          this.removeFromQueue(episode);
        })
      }
    }
    .width('100%')
    .padding(8)
    .backgroundColor($r('app.color.background_card'))
    .borderRadius(8)
  }

  /**
   * æ„å»ºè¿·ä½ æ’­æ”¾å™¨ - QQéŸ³ä¹é£æ ¼
   */
  @Builder
  buildMiniPlayer() {
    Column() {
      // è¿›åº¦æ¡
      Row() {
        Progress({ value: this.playProgress, total: 100, type: ProgressType.Linear })
          .width('100%')
          .height(2)
          .color($r('app.color.primary'))
          .backgroundColor($r('app.color.progress_track'))
      }
      .width('100%')

      // æ’­æ”¾å™¨å†…å®¹
      Row() {
        // å°é¢å›¾ï¼ˆå¸¦æ—‹è½¬æ•ˆæœçš„è®¾è®¡ï¼‰
        Stack() {
          // åœ†å½¢èƒŒæ™¯
          Circle()
            .width(50)
            .height(50)
            .fill($r('app.color.primary'))
          
          // å°é¢å›¾
          Image(this.currentEpisode?.imageUrl || '')
            .width(44)
            .height(44)
            .borderRadius(22)
            .objectFit(ImageFit.Cover)
        }
        .margin({ left: 12 })
        .onClick(() => {
          console.info('[MainPage] Mini player cover tapped');
          this.openPlayerPage();
        })

        // æ ‡é¢˜å’Œæè¿°
        Column() {
          Marquee({
            start: true,
            step: 4,
            loop: -1,
            fromStart: true,
            src: this.marqueeText || ' '
          })
            .width('100%')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_on_primary'))
            .allowScale(false)

          Row() {
            // æ’­æ”¾æ—¶é—´
            Text(`${this.formatTime(this.currentPlayTime)} / ${this.formatTime(this.totalDuration)}`)
              .fontSize(11)
              .fontColor($r('app.color.text_on_primary_secondary'))
            
            // ç¡çœ å®šæ—¶å™¨å€’è®¡æ—¶
            if (this.sleepTimerRemaining > 0) {
              Text(' Â· ')
                .fontSize(11)
                .fontColor($r('app.color.text_on_primary_secondary'))
              Text(`â° ${this.formatSleepTimer(this.sleepTimerRemaining)}`)
                .fontSize(11)
                .fontColor($r('app.color.primary'))
                .fontWeight(FontWeight.Medium)
            }
          }
          .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12, right: 12 })
        .onClick(() => {
          console.info('[MainPage] Mini player tapped');
          this.openPlayerPage();
        })

        // æ’­æ”¾/æš‚åœæŒ‰é’®
        Button() {
          Text(this.isPlaying ? 'âšâš' : 'â–¶')
            .fontSize(18)
            .fontColor($r('app.color.text_on_primary'))
        }
        .width(40)
        .height(40)
        .backgroundColor($r('app.color.primary'))
        .borderRadius(20)
        .onClick(() => {
          console.info(`[MainPage] Mini player toggle: ${this.isPlaying}`);
          if (this.isPlaying) {
            this.playerService.pause();
          } else {
            this.playerService.resume();
          }
          this.isPlaying = !this.isPlaying;
        })

        // ä¸‹ä¸€é¦–æŒ‰é’®
        Button() {
          Text('â­')
            .fontSize(18)
            .fontColor($r('app.color.text_on_primary'))
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .margin({ right: 8 })
        .onClick(() => {
          console.info('[MainPage] Mini player next');
          this.playNextEpisode();
        })
      }
      .width('100%')
      .height(64)
      .alignItems(VerticalAlign.Center)
    }
    .width('94%')
    .backgroundColor($r('app.color.mini_player_background'))
    .borderRadius(12)
    .margin({ bottom: 16 })
    .shadow({
      radius: 16,
      color: 'rgba(0, 0, 0, 0.2)',
      offsetX: 0,
      offsetY: 4
    })
    .clip(true)
  }

  /**
   * æ ¼å¼åŒ–ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
   */
  formatSleepTimer(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${secs}s`;
    }
  }

  /**
   * æ ¼å¼åŒ–æ’­æ”¾æ—¶é—´
   */
  formatTime(seconds: number): string {
    const totalSeconds = Math.floor(seconds);
    const mins = Math.floor(totalSeconds / 60);
    const hours = Math.floor(mins / 60);
    const remainingSeconds = totalSeconds % 60;

    if (hours > 0) {
      return `${hours}:${(mins % 60).toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    } else {
      return `${mins}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
  }

  /**
   * ç©ºçŠ¶æ€è§†å›¾
   */
  @Builder
  buildEmptyView(title: string, message: string) {
    Column() {
      Text('ğŸ§')
        .fontSize(80)
        .opacity(0.3)

      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 20 })

      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
