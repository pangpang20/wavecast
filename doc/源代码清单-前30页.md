# WaveCast 源代码清单（前30页）

**著作权人：** 陈云亮  
**开发者：** 陈云亮  
**联系邮箱：** 676814828@qq.com  
**软件名称：** WaveCast  
**版本号：** 1.0.3  
**开发语言：** ArkTS  
**目标平台：** HarmonyOS API 12+  
**文档说明：** 本文档展示应用的核心源代码（前30页部分）

---

## 目录结构

```
antennaPodHM/
├── AppScope/
│   ├── app.json5           # 应用全局配置
│   └── resources/          # 全局资源
├── entry/
│   └── src/
│       └── main/
│           ├── ets/
│           │   ├── common/         # 公共工具类
│           │   │   ├── Constants.ets
│           │   │   └── UIUtils.ets
│           │   ├── entryability/   # 应用入口
│           │   │   └── EntryAbility.ets
│           │   ├── model/          # 数据模型
│           │   │   ├── AppSettings.ets
│           │   │   ├── Episode.ets
│           │   │   ├── Podcast.ets
│           │   │   └── QueueItem.ets
│           │   ├── pages/          # 页面
│           │   │   ├── MainPage.ets
│           │   │   ├── PlayerPage.ets
│           │   │   ├── SearchPage.ets
│           │   │   ├── PodcastDetailPage.ets
│           │   │   ├── EpisodeDetailPage.ets
│           │   │   ├── QueuePage.ets
│           │   │   ├── DownloadPage.ets
│           │   │   ├── SettingsPage.ets
│           │   │   └── SubscriptionPage.ets
│           │   └── service/        # 业务服务
│           │       ├── DatabaseService.ets
│           │       ├── PlayerService.ets
│           │       ├── PodcastService.ets
│           │       ├── DownloadService.ets
│           │       └── SettingsService.ets
│           ├── resources/          # 资源文件
│           └── module.json5        # 模块配置
└── build-profile.json5            # 构建配置
```

---

## 第1页：应用入口 - EntryAbility.ets（第1-50行）

```typescript
import UIAbility from '@ohos.app.ability.UIAbility';
import AbilityConstant from '@ohos.app.ability.AbilityConstant';
import Want from '@ohos.app.ability.Want';
import window from '@ohos.window';
import abilityAccessCtrl, { Permissions } from '@ohos.abilityAccessCtrl';
import bundleManager from '@ohos.bundle.bundleManager';
import { BusinessError } from '@ohos.base';
import { DatabaseService } from '../service/DatabaseService';
import { SettingsService } from '../service/SettingsService';
import { PlayerService } from '../service/PlayerService';
import { DownloadService } from '../service/DownloadService';

/**
 * 应用入口类
 * 负责应用生命周期管理、服务初始化和权限请求
 */
export default class EntryAbility extends UIAbility {
  private permissionsGranted: boolean = false;

  /**
   * 应用创建时的回调
   * 初始化所有核心服务
   */
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    console.info('EntryAbility onCreate');
    
    // 初始化服务
    this.initServices();
  }

  /**
   * 应用销毁时的回调
   * 释放播放器等资源
   */
  onDestroy(): void {
    console.info('EntryAbility onDestroy');
    
    // 释放播放器资源
    PlayerService.getInstance().release();
  }

  /**
   * 窗口创建时的回调
   * 请求必要权限并加载主页面
   */
  onWindowStageCreate(windowStage: window.WindowStage): void {
    console.info('EntryAbility onWindowStageCreate');

    // 先请求权限，再加载页面
    this.requestPermissions().then(() => {
      windowStage.loadContent('pages/MainPage', (err) => {
        if (err.code) {
```

---

## 第2页：EntryAbility.ets（第51-100行）

```typescript
          console.error(`Failed to load the content. Code: ${err.code}, message: ${err.message}`);
          return;
        }
        console.info('Succeeded in loading the content.');
      });
    }).catch((err: BusinessError) => {
      console.error('Permission request failed:', err);
      // 即使权限被拒绝，也加载页面，但功能可能受限
      windowStage.loadContent('pages/MainPage', (err) => {
        if (err.code) {
          console.error(`Failed to load the content. Code: ${err.code}, message: ${err.message}`);
          return;
        }
        console.info('Succeeded in loading the content.');
      });
    });
  }

  onWindowStageDestroy(): void {
    console.info('EntryAbility onWindowStageDestroy');
  }

  onForeground(): void {
    console.info('EntryAbility onForeground');
  }

  onBackground(): void {
    console.info('EntryAbility onBackground');
  }

  /**
   * 初始化服务
   * 按顺序初始化数据库、设置、播放器和下载服务
   */
  private async initServices(): Promise<void> {
    try {
      // 初始化数据库
      await DatabaseService.getInstance().init(this.context);
      
      // 初始化设置
      await SettingsService.getInstance().init(this.context);
      
      // 初始化播放器（设置 Context 以支持后台播放）
      PlayerService.getInstance().setContext(this.context);
      await PlayerService.getInstance().init();
      
      // 初始化下载服务
      DownloadService.getInstance().setContext(this.context);
      
      console.info('All services initialized successfully');
```

---

## 第3页：EntryAbility.ets（第101-153行）+ Constants.ets

```typescript
    } catch (error) {
      console.error('Failed to initialize services:', error);
    }
  }

  /**
   * 请求必要权限
   * 包括网络权限和后台运行权限
   */
  private async requestPermissions(): Promise<void> {
    try {
      const atManager = abilityAccessCtrl.createAtManager();
      const bundleInfo = await bundleManager.getBundleInfoForSelf(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION);
      const tokenId = bundleInfo.appInfo.accessTokenId;

      // 必要权限：联网
      const requiredPermissions: Permissions[] = [
        'ohos.permission.INTERNET',
        'ohos.permission.GET_NETWORK_INFO'
      ];

      // 可选权限：后台运行（用于后台播放）
      const optionalPermissions: Permissions[] = [
        'ohos.permission.KEEP_BACKGROUND_RUNNING'
      ];

      // 检查并请求必要权限
      const permissionsToRequest: Permissions[] = [];
      
      for (const permission of requiredPermissions) {
        const grantStatus = await atManager.checkAccessToken(tokenId, permission);
        if (grantStatus !== abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
          permissionsToRequest.push(permission);
        }
      }

      // 检查可选权限
      for (const permission of optionalPermissions) {
        const grantStatus = await atManager.checkAccessToken(tokenId, permission);
        if (grantStatus !== abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
          permissionsToRequest.push(permission);
        }
      }

      // 如果有需要请求的权限
      if (permissionsToRequest.length > 0) {
        console.info('Requesting permissions:', permissionsToRequest);
        
        try {
          await atManager.requestPermissionsFromUser(this.context, permissionsToRequest);
          console.info('Permissions granted successfully');
```

---

## 第4页：Constants.ets 完整代码

```typescript
/**
 * 应用常量定义
 * 包含数据库、网络、文件路径等配置常量
 */
export class Constants {
  // ===== 数据库常量 =====
  static readonly DB_NAME: string = 'wavecast.db';
  static readonly DB_VERSION: number = 2;
  
  // 表名
  static readonly TABLE_PODCAST: string = 'podcast';
  static readonly TABLE_EPISODE: string = 'episode';
  static readonly TABLE_QUEUE: string = 'queue';
  
  // ===== Preferences键名 =====
  static readonly PREF_SETTINGS: string = 'app_settings';
  static readonly PREF_THEME: string = 'theme_mode';
  static readonly PREF_PLAYBACK_SPEED: string = 'playback_speed';
  
  // ===== 播放速度选项 =====
  // 符合业界标准：Apple Podcasts, Spotify, Overcast
  static readonly PLAYBACK_SPEEDS: number[] = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.5, 3.0];
  
  // ===== 睡眠定时器选项（分钟）=====
  static readonly SLEEP_TIMER_OPTIONS: number[] = [5, 10, 15, 30, 45, 60, 90, 120];
  
  // ===== 网络超时设置 =====
  static readonly HTTP_TIMEOUT: number = 15000; // 15秒 - RSS获取超时
  static readonly DOWNLOAD_TIMEOUT: number = 300000; // 5分钟 - 下载超时
  
  // ===== 分页设置 =====
  static readonly PAGE_SIZE: number = 20;
  
  // ===== 文件路径 =====
  static readonly DOWNLOAD_DIR: string = 'podcasts';    // 下载目录
  static readonly CACHE_DIR: string = 'cache';          // 缓存目录
  
  // ===== 事件名称 =====
  static readonly EVENT_PLAYBACK_STATE_CHANGED: string = 'playback_state_changed';
  static readonly EVENT_DOWNLOAD_PROGRESS: string = 'download_progress';
  static readonly EVENT_PODCAST_UPDATED: string = 'podcast_updated';
}
```

---

## 第5页：UIUtils.ets（第1-50行）

```typescript
// UI工具类 - 封装 promptAction/router API
import { promptAction, router, UIContext } from '@kit.ArkUI';

/**
 * 路由参数类
 * 用于页面跳转时传递参数
 */
export class RouteParams {
  episodeId?: string;
  podcastId?: string;
}

/**
 * 按钮配置类
 * 用于对话框和操作菜单的按钮配置
 */
export class ButtonOptions {
  text: string = '';
  color: string = '#000000';

  constructor(text: string, color?: string) {
    this.text = text;
    this.color = color || '#000000';
  }
}

/**
 * Toast提示配置类
 */
export class ToastOptions {
  message: string = '';
  duration: number = 2000;

  constructor(message: string, duration?: number) {
    this.message = message;
    this.duration = duration || 2000;
  }
}

/**
 * 对话框配置类
 */
export class DialogOptions {
  title: string = '';
  message: string = '';
  buttons: ButtonOptions[] = [];

  constructor(title?: string, message?: string, buttons?: ButtonOptions[]) {
    this.title = title || '';
    this.message = message || '';
    this.buttons = buttons || [];
```

---

## 第6页：UIUtils.ets（第51-100行）

```typescript
  }
}

/**
 * 操作菜单配置类
 */
export class ActionMenuOptions {
  title: string = '';
  buttons: ButtonOptions[] = [];

  constructor(title?: string, buttons?: ButtonOptions[]) {
    this.title = title || '';
    this.buttons = buttons || [];
  }
}

/**
 * UI工具类
 * 封装常用的UI操作，包括Toast、Dialog、路由等
 */
export class UIUtils {
  private static uiContext: UIContext | null = null;

  /**
   * 页面初始化时调用，设置UI上下文
   */
  static setUIContext(context: UIContext): void {
    UIUtils.uiContext = context;
  }

  /**
   * 显示Toast提示
   * @param options Toast配置选项
   */
  static showToast(options: ToastOptions): void {
    try {
      if (UIUtils.uiContext) {
        UIUtils.uiContext.getPromptAction().showToast({
          message: options.message,
          duration: options.duration
        });
      } else {
        // fallback - 使用全局API
        promptAction.showToast({
          message: options.message,
          duration: options.duration
        });
      }
    } catch (error) {
      console.error('[UIUtils] showToast failed:', error);
    }
  }
```

---

## 第7页：UIUtils.ets（第101-150行）

```typescript
  /**
   * 显示对话框
   * @param options 对话框配置选项
   * @returns 返回用户点击的按钮索引
   */
  static async showDialog(options: DialogOptions): Promise<number> {
    try {
      // 转换按钮类型
      const dialogButtons: promptAction.Button[] = options.buttons.map(btn => {
        const dialogBtn: promptAction.Button = {
          text: btn.text,
          color: btn.color
        };
        return dialogBtn;
      });
      
      let result: promptAction.ShowDialogSuccessResponse;
      if (UIUtils.uiContext) {
        result = await UIUtils.uiContext.getPromptAction().showDialog({
          title: options.title,
          message: options.message,
          buttons: dialogButtons
        });
      } else {
        result = await promptAction.showDialog({
          title: options.title,
          message: options.message,
          buttons: dialogButtons
        });
      }
      return result.index;
    } catch (error) {
      console.error('[UIUtils] showDialog failed:', error);
      return -1;
    }
  }

  /**
   * 显示操作菜单
   * @param options 操作菜单配置选项
   * @returns 返回用户选择的菜单项索引
   */
  static async showActionMenu(options: ActionMenuOptions): Promise<number> {
    try {
      // 转换按钮类型
      const actionButtons: promptAction.Button[] = options.buttons.map(btn => {
        const actionBtn: promptAction.Button = {
          text: btn.text,
          color: btn.color
        };
```

---

## 第8页：UIUtils.ets（第151-186行）+ Podcast.ets开始

```typescript
        return actionBtn;
      });
      
      let result: promptAction.ActionMenuSuccessResponse;
      if (UIUtils.uiContext) {
        result = await UIUtils.uiContext.getPromptAction().showActionMenu({
          title: options.title,
          buttons: actionButtons as [promptAction.Button, promptAction.Button?, promptAction.Button?, promptAction.Button?, promptAction.Button?, promptAction.Button?]
        });
      } else {
        result = await promptAction.showActionMenu({
          title: options.title,
          buttons: actionButtons as [promptAction.Button, promptAction.Button?, promptAction.Button?, promptAction.Button?, promptAction.Button?, promptAction.Button?]
        });
      }
      return result.index;
    } catch (error) {
      console.error('[UIUtils] showActionMenu failed:', error);
      return -1;
    }
  }

  /**
   * 页面跳转
   * @param url 目标页面路径
   * @param params 路由参数
   */
  static pushUrl(url: string, params?: RouteParams): void {
    try {
      // 转换参数格式
      let routerParams: Record<string, Object> | undefined = undefined;
      if (params) {
        routerParams = {};
        if (params.episodeId !== undefined) {
          routerParams['episodeId'] = params.episodeId;
        }
        if (params.podcastId !== undefined) {
          routerParams['podcastId'] = params.podcastId;
        }
      }
      router.pushUrl({
        url: url,
        params: routerParams
      }).catch((err: Error) => {
        console.error('[UIUtils] Navigation failed:', err);
      });
    } catch (error) {
      console.error('[UIUtils] pushUrl failed:', error);
    }
  }
```

---

## 第9页：Podcast.ets（完整代码）

```typescript
/**
 * 播客实体类
 * 表示一个播客节目，包含基本信息和刷新策略
 */
export class Podcast {
  id: string = '';                    // 播客唯一ID
  title: string = '';                 // 播客标题
  author: string = '';                // 作者
  description: string = '';           // 描述
  imageUrl: string = '';              // 封面图片URL
  feedUrl: string = '';               // RSS订阅地址
  link: string = '';                  // 官网链接
  language: string = '';              // 语言
  category: string = '';              // 分类
  subscribeDate: number = 0;          // 订阅时间戳
  lastUpdate: number = 0;             // 最后更新时间
  episodeCount: number = 0;           // 单集数量
  isSubscribed: boolean = false;      // 是否已订阅
  isFetchFailed: boolean = false;     // 是否获取失败
  lastSuccessfulFetch: number = 0;    // 最后成功刷新时间

  /**
   * 创建播客实例的工厂方法
   */
  static create(id: string, title: string, feedUrl: string): Podcast {
    let podcast = new Podcast();
    podcast.id = id;
    podcast.title = title;
    podcast.feedUrl = feedUrl;
    return podcast;
  }

  /**
   * 判断是否需要刷新
   * 规则：
   * - 新订阅1分钟内每5秒刷新一次
   * - 超过1分钟后每2小时刷新一次
   * - 已标记为获取失败的不再刷新
   */
  needsRefresh(): boolean {
    if (this.isFetchFailed) {
      return false;
    }

    const now = Date.now();
    const subscribeAge = now - this.subscribeDate;
    const lastFetchAge = now - this.lastSuccessfulFetch;

    const ONE_MINUTE = 60 * 1000;
    const FIVE_SECONDS = 5 * 1000;
    const TWO_HOURS = 2 * 60 * 60 * 1000;

    if (subscribeAge < ONE_MINUTE) {
      // 新订阅1分钟内，每5秒刷新一次
      return lastFetchAge >= FIVE_SECONDS;
    } else {
      // 超过1分钟后，每2小时刷新一次
      return lastFetchAge >= TWO_HOURS;
    }
  }
}
```

---

## 第10页：Episode.ets（第1-50行）

```typescript
/**
 * 下载状态枚举
 */
export enum DownloadStatus {
  NOT_DOWNLOADED = 0,     // 未下载
  DOWNLOADING = 1,        // 下载中
  DOWNLOADED = 2,         // 已下载
  FAILED = 3              // 下载失败
}

/**
 * 单集实体类
 * 表示播客的一个单集，包含媒体信息和播放下载状态
 */
export class Episode {
  id: string = '';                      // 单集唯一ID
  podcastId: string = '';               // 所属播客ID
  title: string = '';                   // 标题
  description: string = '';             // 描述/简介
  link: string = '';                    // 链接
  audioUrl: string = '';                // 音频文件URL
  imageUrl: string = '';                // 封面图片URL
  duration: number = 0;                 // 时长（秒）
  fileSize: number = 0;                 // 文件大小（字节）
  pubDate: number = 0;                  // 发布时间戳
  downloadStatus: DownloadStatus = DownloadStatus.NOT_DOWNLOADED;  // 下载状态
  downloadProgress: number = 0;         // 下载进度 0-100
  localPath: string = '';               // 本地文件路径
  playbackPosition: number = 0;         // 播放位置（秒）
  isPlayed: boolean = false;            // 是否已播放
  isFavorite: boolean = false;          // 是否收藏
  addedToQueueDate: number = 0;         // 添加到队列的时间

  /**
   * 格式化时长显示
   * @returns 格式化后的时长字符串（如："1:23:45" 或 "23:45"）
   */
  getFormattedDuration(): string {
    const hours = Math.floor(this.duration / 3600);
    const minutes = Math.floor((this.duration % 3600) / 60);
    const seconds = this.duration % 60;

    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  }
```

---

## 第11页：Episode.ets（第51-74行）+ AppSettings.ets

```typescript
  /**
   * 格式化文件大小
   * @returns 格式化后的文件大小字符串（如："25.5 MB"）
   */
  getFormattedFileSize(): string {
    if (this.fileSize < 1024) {
      return `${this.fileSize} B`;
    } else if (this.fileSize < 1024 * 1024) {
      return `${(this.fileSize / 1024).toFixed(2)} KB`;
    } else if (this.fileSize < 1024 * 1024 * 1024) {
      return `${(this.fileSize / (1024 * 1024)).toFixed(2)} MB`;
    } else {
      return `${(this.fileSize / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    }
  }

  /**
   * 格式化发布日期
   * @returns 格式化后的日期字符串（如："2025-12-22"）
   */
  getFormattedPubDate(): string {
    if (!this.pubDate) {
      return '';
    }
    const date = new Date(this.pubDate);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
}
```

**AppSettings.ets 完整代码：**

```typescript
/**
 * 主题模式枚举
 */
export enum ThemeMode {
  LIGHT = 'light',    // 浅色主题
  DARK = 'dark',      // 深色主题
  AUTO = 'auto'       // 跟随系统
}

/**
 * 应用设置类
 * 存储用户的各项偏好设置
 */
export class AppSettings {
  // ===== 主题设置 =====
  themeMode: ThemeMode = ThemeMode.AUTO;

  // ===== 网络设置 =====
```

---

## 第12页：AppSettings.ets + QueueItem.ets

```typescript
  wifiOnlyDownload: boolean = true;         // 仅WiFi下下载
  autoDownloadNewEpisodes: boolean = false; // 自动下载新单集

  // ===== 播放设置 =====
  playbackSpeed: number = 1.0;              // 播放速度
  skipSilence: boolean = false;             // 跳过静音
  sleepTimerMinutes: number = 0;            // 睡眠定时器（分钟）
  continuePlayback: boolean = true;         // 自动续播

  // ===== 存储设置 =====
  storagePath: string = '';                 // 存储路径
  autoDeletePlayed: boolean = false;        // 自动删除已播放
  keepLastNEpisodes: number = 5;            // 保留最近N集

  // ===== 通知设置 =====
  enableNotifications: boolean = false;     // 启用通知
  notifyNewEpisodes: boolean = false;       // 新单集通知
}
```

**QueueItem.ets 完整代码：**

```typescript
/**
 * 播放队列项实体类
 * 表示播放队列中的一个条目
 */
export class QueueItem {
  id: string = '';              // 队列项唯一ID
  episodeId: string = '';       // 关联的单集ID
  position: number = 0;         // 队列中的位置（排序用）
  addedDate: number = 0;        // 添加到队列的时间戳
}
```

---

## 第13页：PlayerService.ets（第1-50行）

```typescript
import media from '@ohos.multimedia.media';
import avSession from '@ohos.multimedia.avsession';
import wantAgent from '@ohos.app.ability.wantAgent';
import backgroundTaskManager from '@ohos.resourceschedule.backgroundTaskManager';
import fs from '@ohos.file.fs';
import { Episode } from '../model/Episode';
import { SettingsService } from './SettingsService';
import { DatabaseService } from './DatabaseService';
import { DownloadService } from './DownloadService';

/**
 * 播放器状态枚举
 */
export enum PlayerState {
  IDLE = 'idle',          // 空闲
  LOADING = 'loading',    // 加载中
  PLAYING = 'playing',    // 播放中
  PAUSED = 'paused',      // 已暂停
  STOPPED = 'stopped',    // 已停止
  ERROR = 'error'         // 错误
}

/**
 * 播放器服务类
 * 负责音频播放、后台播放、媒体会话管理等核心功能
 * 使用单例模式确保全局只有一个播放器实例
 */
export class PlayerService {
  private static instance: PlayerService;
  private avPlayer: media.AVPlayer | null = null;              // 音视频播放器
  private session: avSession.AVSession | null = null;          // 媒体会话
  private currentEpisode: Episode | null = null;               // 当前播放的单集
  private state: PlayerState = PlayerState.IDLE;               // 播放状态
  private playbackSpeed: number = 1.0;                         // 播放速度
  private listeners: Map<string, Function[]> = new Map();      // 事件监听器
  private context: Context | null = null;                      // 应用上下文
  private isBackgroundRunning: boolean = false;                // 是否在后台运行
  private sleepTimerId: number = -1;                           // 睡眠定时器ID
  private sleepTimerMinutes: number = 0;                       // 睡眠定时器分钟数
  private sleepTimerStartTime: number = 0;                     // 定时器开始时间

  private constructor() {}

  /**
   * 获取单例实例
   */
  static getInstance(): PlayerService {
    if (!PlayerService.instance) {
      PlayerService.instance = new PlayerService();
    }
```

---

## 第14页：PlayerService.ets（第51-100行）

```typescript
    return PlayerService.instance;
  }

  /**
   * 设置应用上下文
   * 用于后台播放和媒体会话
   */
  setContext(context: Context): void {
    this.context = context;
  }

  /**
   * 初始化播放器
   * 创建 AVPlayer 实例并设置回调
   */
  async init(): Promise<void> {
    if (this.avPlayer) {
      return;
    }

    try {
      // 从设置中加载默认播放速度
      const settingsService = SettingsService.getInstance();
      this.playbackSpeed = settingsService.getPlaybackSpeed();
      console.info(`[PlayerService] Default playback speed: ${this.playbackSpeed}`);

      this.avPlayer = await media.createAVPlayer();
      this.setupPlayerCallbacks();
      await this.initAVSession();
    } catch (error) {
      console.error('Failed to initialize player:', error);
    }
  }

  /**
   * 初始化 AVSession
   * 支持后台播放和媒体控制中心
   */
  private async initAVSession(): Promise<void> {
    if (!this.context) {
      console.warn('Context not set, AVSession will not be initialized');
      return;
    }

    try {
      // 创建 AVSession
      this.session = await avSession.createAVSession(this.context, 'WaveCast', 'audio');
      
      // 设置播放命令回调
      this.session.on('play', () => {
        this.resume();
```

---

## 第15页：PlayerService.ets（第101-150行）

```typescript
      });
      
      this.session.on('pause', () => {
        this.pause();
      });
      
      this.session.on('stop', () => {
        this.stop();
      });
      
      this.session.on('seek', (time: number) => {
        this.seek(time);
      });

      // 激活 session
      await this.session.activate();
      console.info('AVSession initialized successfully');
    } catch (error) {
      console.error('Failed to initialize AVSession:', error);
    }
  }

  /**
   * 更新 AVSession 媒体信息
   * 在媒体控制中心显示当前播放信息
   */
  private async updateSessionMetadata(): Promise<void> {
    if (!this.session || !this.currentEpisode) {
      return;
    }

    try {
      const metadata: avSession.AVMetadata = {
        assetId: this.currentEpisode.id,
        title: this.currentEpisode.title,
        artist: 'Podcast',
        duration: this.currentEpisode.duration
      };
      await this.session.setAVMetadata(metadata);
    } catch (error) {
      console.error('Failed to update session metadata:', error);
    }
  }

  /**
   * 更新 AVSession 播放状态
   * 同步播放状态到媒体控制中心
   */
  private async updateSessionPlaybackState(): Promise<void> {
    if (!this.session) {
      return;
```

---

## 第16页：PlayerService.ets（第151-200行）

```typescript
    }

    try {
      let sessionState: avSession.PlaybackState = avSession.PlaybackState.PLAYBACK_STATE_STOP;
      switch (this.state) {
        case PlayerState.PLAYING:
          sessionState = avSession.PlaybackState.PLAYBACK_STATE_PLAY;
          break;
        case PlayerState.PAUSED:
          sessionState = avSession.PlaybackState.PLAYBACK_STATE_PAUSE;
          break;
        case PlayerState.STOPPED:
          sessionState = avSession.PlaybackState.PLAYBACK_STATE_STOP;
          break;
      }

      const playbackState: avSession.AVPlaybackState = {
        state: sessionState,
        position: {
          elapsedTime: this.currentEpisode?.playbackPosition || 0,
          updateTime: Date.now()
        },
        speed: this.playbackSpeed
      };
      await this.session.setAVPlaybackState(playbackState);
    } catch (error) {
      console.error('Failed to update session playback state:', error);
    }
  }

  /**
   * 开始后台任务
   * 允许应用在后台继续播放音频
   */
  private async startBackgroundTask(): Promise<void> {
    if (this.isBackgroundRunning || !this.context) {
      return;
    }

    try {
      const wantAgentInfo: wantAgent.WantAgentInfo = {
        wants: [
          {
            bundleName: 'com.pangpang.wavecast',
            abilityName: 'EntryAbility'
          }
        ],
        operationType: wantAgent.OperationType.START_ABILITY,
        requestCode: 0,
        wantAgentFlags: [wantAgent.WantAgentFlags.UPDATE_PRESENT_FLAG]
```

---

## 第17页：PlayerService.ets（第201-250行）

```typescript
      };

      const agent = await wantAgent.getWantAgent(wantAgentInfo);

      await backgroundTaskManager.startBackgroundRunning(
        this.context,
        backgroundTaskManager.BackgroundMode.AUDIO_PLAYBACK,
        agent
      );

      this.isBackgroundRunning = true;
      console.info('Background task started');
    } catch (error) {
      console.error('Failed to start background task:', error);
    }
  }

  /**
   * 停止后台任务
   */
  private async stopBackgroundTask(): Promise<void> {
    if (!this.isBackgroundRunning || !this.context) {
      return;
    }

    try {
      await backgroundTaskManager.stopBackgroundRunning(this.context);
      this.isBackgroundRunning = false;
      console.info('Background task stopped');
    } catch (error) {
      console.error('Failed to stop background task:', error);
    }
  }

  /**
   * 设置播放器回调
   * 监听状态变化、时间更新、错误等事件
   */
  private setupPlayerCallbacks(): void {
    if (!this.avPlayer) return;

    // 监听状态变化
    this.avPlayer.on('stateChange', (state: string) => {
      console.info(`AVPlayer state changed to: ${state}`);
      this.updateState(state);
      
      // 监听播放完成事件
      if (state === 'completed') {
        console.info('[PlayerService] Playback completed');
        this.handlePlaybackCompleted();
```

---

## 第18页：PlayerService.ets（第251-300行）

```typescript
      }
    });

    // 监听错误
    this.avPlayer.on('error', (err) => {
      console.error('AVPlayer error:', err);
      this.state = PlayerState.ERROR;
      this.notifyListeners('error', err);
    });

    // 监听播放进度更新
    this.avPlayer.on('timeUpdate', (timeInMs: number) => {
      if (this.currentEpisode) {
        // AVPlayer 返回的是毫秒，转换为秒
        const timeInSeconds = Math.floor(timeInMs / 1000);
        this.currentEpisode.playbackPosition = timeInSeconds;
        this.notifyListeners('timeUpdate', timeInSeconds);
      }
    });

    // 监听时长更新
    this.avPlayer.on('durationUpdate', (durationInMs: number) => {
      if (this.currentEpisode) {
        const durationInSeconds = Math.floor(durationInMs / 1000);
        console.info(`[PlayerService] Duration updated: ${durationInSeconds}s`);
        this.currentEpisode.duration = durationInSeconds;
        this.notifyListeners('durationUpdate', durationInSeconds);
      }
    });
  }

  /**
   * 处理播放完成事件
   * 自动删除已播放单集（如果设置启用）
   * 自动播放队列下一集（如果设置启用）
   */
  private async handlePlaybackCompleted(): Promise<void> {
    try {
      console.info('[PlayerService] handlePlaybackCompleted start');
      
      const settingsService = SettingsService.getInstance();
      
      // 检查是否开启了自动删除已播放
      const autoDeletePlayed = settingsService.getAutoDeletePlayed();
      if (autoDeletePlayed && this.currentEpisode && this.currentEpisode.localPath) {
        console.info(`[PlayerService] Auto-delete enabled, deleting: ${this.currentEpisode.title}`);
        try {
          await DownloadService.getInstance().deleteDownloadedFile(this.currentEpisode);
          console.info('[PlayerService] Deleted played episode file');
```

---

## 第19页：PlayerService.ets（第301-350行）

```typescript
        } catch (deleteError) {
          console.error('[PlayerService] Failed to delete played episode:', deleteError);
        }
      }
      
      // 检查是否开启了自动续播
      const continuePlayback = settingsService.getContinuePlayback();
      console.info(`[PlayerService] Continue playback setting: ${continuePlayback}`);
      
      if (!continuePlayback) {
        console.info('[PlayerService] Auto-play is disabled, stopping');
        this.notifyListeners('playbackCompleted', null);
        return;
      }
      
      // 获取待听队列中的下一个单集
      const db = DatabaseService.getInstance();
      const queueEpisodes = await db.getQueueEpisodes();
      console.info(`[PlayerService] Queue has ${queueEpisodes.length} episodes`);
      
      if (queueEpisodes.length === 0) {
        console.info('[PlayerService] Queue is empty, stopping');
        this.notifyListeners('playbackCompleted', null);
        return;
      }
      
      // 播放队列中的第一个单集
      const nextEpisode = queueEpisodes[0];
      console.info(`[PlayerService] Playing next episode: ${nextEpisode.title}`);
      
      // 从队列中移除
      await db.removeFromQueue(nextEpisode.id);
      console.info(`[PlayerService] Removed from queue: ${nextEpisode.id}`);
      
      // 播放下一个单集
      await this.playEpisode(nextEpisode);
      
      // 通知监听者队列已更新
      this.notifyListeners('queueUpdated', null);
      console.info('[PlayerService] Auto-play next episode completed');
    } catch (error) {
      console.error('[PlayerService] Failed to handle playback completion:', error);
      this.notifyListeners('playbackCompleted', null);
    }
  }

  /**
   * 播放单集
   * @param episode 要播放的单集
   */
  async playEpisode(episode: Episode): Promise<void> {
```

---

## 第20页：PlayerService.ets（第351-400行）

```typescript
    try {
      console.info('[PlayerService] playEpisode start:', episode.title);
      console.info('[PlayerService] audioUrl:', episode.audioUrl);
      console.info('[PlayerService] localPath:', episode.localPath);

      // 设置加载状态
      this.state = PlayerState.LOADING;
      this.notifyListeners('stateChange', this.state);

      if (!this.avPlayer) {
        console.info('[PlayerService] Initializing player...');
        await this.init();
      }

      if (!this.avPlayer) {
        throw new Error('Failed to initialize player');
      }

      // 检查当前状态，如果不是 idle 状态，需要重置
      const currentState = this.avPlayer.state;
      console.info(`[PlayerService] Current AVPlayer state: ${currentState}`);
      
      // 如果不是 idle 状态，需要重置播放器
      if (currentState !== 'idle') {
        console.info(`[PlayerService] Resetting player from ${currentState} to idle...`);
        await this.avPlayer.reset();
        await this.waitForState('idle', 3000);
        console.info('[PlayerService] Player reset to idle state');
      }

      this.currentEpisode = episode;

      // 确定音频源（优先使用本地文件）
      const isLocalFile = episode.localPath && episode.localPath.length > 0;
      const audioSource = isLocalFile ? episode.localPath : episode.audioUrl;
      
      if (!audioSource || audioSource.trim().length === 0) {
        throw new Error('No valid audio URL found for episode');
      }

      console.info(`[PlayerService] Audio source: ${audioSource}, isLocal: ${isLocalFile}`);

      // 根据源类型设置播放器
      if (isLocalFile) {
        // 本地文件使用 fdSrc
        console.info('[PlayerService] Opening local file...');
        const file = await fs.open(audioSource, fs.OpenMode.READ_ONLY);
        const avFileDescriptor: media.AVFileDescriptor = {
          fd: file.fd,
```

---

## 第21页：PlayerService.ets（第401-450行）

```typescript
          offset: 0,
          length: -1  // -1 表示整个文件
        };
        this.avPlayer.fdSrc = avFileDescriptor;
        console.info('[PlayerService] Local file fd set:', file.fd);
      } else {
        // 网络 URL 直接设置 url
        console.info('[PlayerService] Setting network URL...');
        this.avPlayer.url = audioSource;
      }

      // 等待播放器进入 initialized 状态
      console.info('[PlayerService] Waiting for initialized state...');
      await this.waitForState('initialized', 10000);
      console.info('[PlayerService] Player initialized');

      // 调用 prepare 让播放器准备资源
      console.info('[PlayerService] Calling prepare()...');
      await this.avPlayer.prepare();

      // 等待播放器准备就绪
      console.info('[PlayerService] Waiting for prepared state...');
      await this.waitForState('prepared', 15000);
      console.info('[PlayerService] Player prepared successfully');

      // 如果有保存的播放进度，跳转到该位置
      if (episode.playbackPosition > 0) {
        console.info('[PlayerService] Seeking to position:', episode.playbackPosition);
        await this.seek(episode.playbackPosition);
      }

      // 设置播放速度
      if (this.playbackSpeed !== 1.0) {
        console.info('[PlayerService] Setting playback speed:', this.playbackSpeed);
        await this.setPlaybackSpeed(this.playbackSpeed);
      }

      // 开始后台任务
      console.info('[PlayerService] Starting background task...');
      await this.startBackgroundTask();

      // 更新媒体信息
      console.info('[PlayerService] Updating session metadata...');
      await this.updateSessionMetadata();

      // 开始播放
      console.info('[PlayerService] Calling play()...');
      await this.avPlayer.play();
      console.info('[PlayerService] playEpisode completed successfully');
```

---

## 第22页：PlayerService.ets（第451-500行）

```typescript
      
      // 标记为已播放
      await DatabaseService.getInstance().markEpisodeAsPlayed(episode.id);
      console.info(`[PlayerService] Marked episode ${episode.id} as played`);
      
      // 打印 AVPlayer 信息
      console.info(`[PlayerService] AVPlayer duration: ${this.avPlayer.duration}ms`);
      console.info(`[PlayerService] AVPlayer currentTime: ${this.avPlayer.currentTime}ms`);
    } catch (error) {
      console.error('[PlayerService] Failed to play episode:', error);
      this.state = PlayerState.ERROR;
      this.notifyListeners('error', error);
    }
  }

  /**
   * 暂停播放
   */
  async pause(): Promise<void> {
    try {
      if (this.avPlayer && this.state === PlayerState.PLAYING) {
        await this.avPlayer.pause();
      }
    } catch (error) {
      console.error('Failed to pause:', error);
    }
  }

  /**
   * 继续播放
   * 重新应用播放速度以确保一致性
   */
  async resume(): Promise<void> {
    try {
      if (this.avPlayer && this.state === PlayerState.PAUSED) {
        await this.avPlayer.play();
        // 恢复播放时重新应用播放速度
        if (this.playbackSpeed !== 1.0) {
          await this.avPlayer.setSpeed(this.playbackSpeed);
          console.info(`[PlayerService] Resume with speed: ${this.playbackSpeed}`);
        }
      }
    } catch (error) {
      console.error('Failed to resume:', error);
    }
  }

  /**
   * 停止播放
   */
```

---

## 第23页：PlayerService.ets（第501-550行）

```typescript
  async stop(): Promise<void> {
    try {
      if (this.avPlayer) {
        await this.avPlayer.stop();
        this.currentEpisode = null;
      }
      // 停止后台任务
      await this.stopBackgroundTask();
    } catch (error) {
      console.error('Failed to stop:', error);
    }
  }

  /**
   * 跳转到指定位置
   * @param positionInSeconds 目标位置（秒）
   */
  async seek(positionInSeconds: number): Promise<void> {
    if (this.avPlayer) {
      const positionInMs = Math.floor(positionInSeconds * 1000);
      console.info(`[PlayerService] Seeking to ${positionInSeconds}s (${positionInMs}ms)`);
      await this.avPlayer.seek(positionInMs);
    }
  }

  /**
   * 设置播放速度
   * @param speed 播放速度（0.5 - 3.0）
   */
  async setPlaybackSpeed(speed: number): Promise<void> {
    if (this.avPlayer) {
      this.playbackSpeed = speed;
      await this.avPlayer.setSpeed(speed);
      console.info(`[PlayerService] Playback speed set to: ${speed}`);
    }
  }

  /**
   * 获取当前播放速度
   */
  getPlaybackSpeed(): number {
    return this.playbackSpeed;
  }

  /**
   * 获取当前播放位置（秒）
   */
  getCurrentPosition(): number {
    return this.currentEpisode?.playbackPosition || 0;
  }

  /**
```

---

## 第24页：PlayerService.ets（第551-600行）

```typescript
   * 获取总时长（秒）
   */
  getDuration(): number {
    // 优先使用 AVPlayer 的时长
    if (this.avPlayer && this.avPlayer.duration > 0) {
      return Math.floor(this.avPlayer.duration / 1000);
    }
    return this.currentEpisode?.duration || 0;
  }

  /**
   * 获取当前播放状态
   */
  getState(): PlayerState {
    return this.state;
  }

  /**
   * 获取当前播放的单集
   */
  getCurrentEpisode(): Episode | null {
    return this.currentEpisode;
  }

  /**
   * 播放队列相关
   */
  private playQueue: Episode[] = [];

  addToQueue(episode: Episode): void {
    this.playQueue.push(episode);
  }

  getQueue(): Episode[] {
    return this.playQueue.slice();
  }

  clearQueue(): void {
    this.playQueue = [];
  }

  removeFromQueue(index: number): void {
    if (index >= 0 && index < this.playQueue.length) {
      this.playQueue.splice(index, 1);
    }
  }

  /**
   * 添加事件监听器
   * @param event 事件名称
   * @param callback 回调函数
   */
```

---

## 第25页：PlayerService.ets（第601-650行）

```typescript
  addEventListener(event: string, callback: Function): void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event)?.push(callback);
  }

  /**
   * 移除事件监听器
   */
  removeEventListener(event: string, callback: Function): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }

  /**
   * 通知监听器
   */
  private notifyListeners(event: string, data?: ESObject): void {
    const callbacks = this.listeners.get(event);
    if (callbacks) {
      callbacks.forEach((callback: Function): void => { callback(data); });
    }
  }

  /**
   * 更新播放状态
   * 将 AVPlayer 状态映射到 PlayerState
   */
  private updateState(avState: string): void {
    switch (avState) {
      case 'playing':
        this.state = PlayerState.PLAYING;
        break;
      case 'paused':
        this.state = PlayerState.PAUSED;
        break;
      case 'stopped':
        this.state = PlayerState.STOPPED;
        break;
      case 'error':
        this.state = PlayerState.ERROR;
        break;
      default:
        this.state = PlayerState.IDLE;
    }
    this.notifyListeners('stateChange', this.state);
```

---

## 第26页：PlayerService.ets（第651-700行）

```typescript
    // 更新 AVSession 播放状态
    this.updateSessionPlaybackState();
  }

  /**
   * 等待播放器到达指定状态（带超时）
   */
  private waitForState(targetState: string, timeoutMs: number = 5000): Promise<void> {
    return new Promise<void>((resolve: () => void, reject: (reason: Error) => void) => {
      const startTime = Date.now();
      const checkState = (): void => {
        if (this.avPlayer?.state === targetState) {
          resolve();
        } else if (Date.now() - startTime > timeoutMs) {
          const error = new Error(`Timeout waiting for state: ${targetState}, current: ${this.avPlayer?.state}`);
          console.error('[PlayerService]', error.message);
          reject(error);
        } else {
          setTimeout(checkState, 100);
        }
      };
      checkState();
    });
  }

  /**
   * 设置睡眠定时器
   * @param minutes 定时分钟数，0表示关闭
   */
  setSleepTimer(minutes: number): void {
    console.info(`[PlayerService] Sleep timer set: ${minutes}min`);
    
    // 清除之前的定时器
    if (this.sleepTimerId !== -1) {
      clearTimeout(this.sleepTimerId);
      this.sleepTimerId = -1;
    }

    this.sleepTimerMinutes = minutes;
    this.sleepTimerStartTime = minutes > 0 ? Date.now() : 0;

    if (minutes > 0) {
      this.sleepTimerId = setTimeout(() => {
        console.info('[PlayerService] Sleep timer fired, pausing');
        this.pause();
        this.sleepTimerId = -1;
        this.sleepTimerMinutes = 0;
        this.sleepTimerStartTime = 0;
        this.notifyListeners('sleepTimerEnd', null);
      }, minutes * 60 * 1000);
    }
  }
```

---

## 第27页：PlayerService.ets（第701-737行）+ 配置文件

```typescript
  /**
   * 获取当前睡眠定时器分钟数
   */
  getSleepTimerMinutes(): number {
    return this.sleepTimerMinutes;
  }

  /**
   * 获取睡眠定时器剩余秒数
   */
  getSleepTimerRemaining(): number {
    if (this.sleepTimerMinutes <= 0 || this.sleepTimerStartTime <= 0) {
      return 0;
    }
    
    const elapsed = Date.now() - this.sleepTimerStartTime;
    const totalMs = this.sleepTimerMinutes * 60 * 1000;
    const remaining = Math.max(0, totalMs - elapsed);
    return Math.ceil(remaining / 1000);
  }

  /**
   * 清除睡眠定时器
   */
  clearSleepTimer(): void {
    if (this.sleepTimerId !== -1) {
      clearTimeout(this.sleepTimerId);
      this.sleepTimerId = -1;
    }
    this.sleepTimerMinutes = 0;
    this.sleepTimerStartTime = 0;
  }

  /**
   * 释放资源
   * 清理播放器、会话和后台任务
   */
  async release(): Promise<void> {
    try {
      // 清除睡眠定时器
      this.clearSleepTimer();

      // 停止后台任务
      await this.stopBackgroundTask();

      // 释放 AVSession
      if (this.session) {
        await this.session.deactivate();
        await this.session.destroy();
        this.session = null;
      }
```

---

## 第28页：应用配置文件 - app.json5 + module.json5

**app.json5 - 应用全局配置：**

```json
{
  "app": {
    "bundleName": "com.pangpang.wavecast",
    "vendor": "陈云亮",
    "versionCode": 1000300,
    "versionName": "1.0.3",
    "icon": "$media:app_icon",
    "label": "$string:app_name",
    "description": "$string:app_description",
    "minAPIVersion": 12,
    "targetAPIVersion": 12,
    "apiReleaseType": "Release1"
  }
}
```

**module.json5 - 模块配置（部分）：**

```json
{
  "module": {
    "name": "entry",
    "type": "entry",
    "description": "$string:module_desc",
    "mainElement": "EntryAbility",
    "deviceTypes": [
      "phone",
      "tablet",
      "2in1"
    ],
    "deliveryWithInstall": true,
    "installationFree": false,
    "pages": "$profile:main_pages",
    "abilities": [
      {
        "name": "EntryAbility",
        "srcEntry": "./ets/entryability/EntryAbility.ets",
        "description": "$string:EntryAbility_desc",
        "icon": "$media:layered_image",
        "label": "$string:EntryAbility_label",
        "startWindowIcon": "$media:startIcon",
        "startWindowBackground": "$color:start_window_background",
        "exported": true,
        "backgroundModes": [
          "audioPlayback"
        ],
```

---

## 第29页：module.json5 权限配置 + build-profile.json5

**module.json5 - 权限配置：**

```json
        "skills": [
          {
            "entities": [
              "entity.system.home"
            ],
            "actions": [
              "ohos.want.action.home"
            ]
          }
        ]
      }
    ],
    "requestPermissions": [
      {
        "name": "ohos.permission.INTERNET",
        "reason": "$string:permission_internet_reason",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "always"
        }
      },
      {
        "name": "ohos.permission.GET_NETWORK_INFO",
        "reason": "$string:permission_network_info_reason",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "always"
        }
      },
      {
        "name": "ohos.permission.KEEP_BACKGROUND_RUNNING",
        "reason": "$string:permission_background_reason",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "always"
        }
      }
    ]
  }
}
```

**build-profile.json5 - 构建配置（部分）：**

```json
{
  "app": {
    "signingConfigs": [
      {
        "name": "default",
```

---

## 第30页：技术架构总结

### 技术栈

**开发语言：** ArkTS  
**UI框架：** ArkUI  
**目标平台：** HarmonyOS API 12+

### 核心技术组件

1. **媒体播放**
   - `@ohos.multimedia.media.AVPlayer` - 音频播放
   - `@ohos.multimedia.avsession` - 媒体会话管理
   - 支持后台播放和媒体控制中心集成

2. **网络通信**
   - `@ohos.net.http` - HTTP请求
   - 支持 RSS/Atom 格式解析
   - 自动重试和错误处理

3. **数据存储**
   - `@ohos.data.relationalStore` - 关系型数据库
   - `@ohos.data.preferences` - 轻量级键值存储
   - 本地文件系统管理

4. **下载管理**
   - `@ohos.request` - 系统下载服务
   - 支持断点续传
   - 下载进度监控

5. **后台任务**
   - `@ohos.resourceschedule.backgroundTaskManager` - 后台任务管理
   - 支持音频播放后台运行

### 架构设计

**设计模式：**
- 单例模式（Service层）
- 观察者模式（事件监听）
- MVC模式（页面-服务-模型）

**核心服务：**
1. **PlayerService** - 播放控制
2. **DatabaseService** - 数据持久化
3. **PodcastService** - 播客管理
4. **DownloadService** - 下载管理
5. **SettingsService** - 设置管理

**关键特性：**
- 播放速度记忆（0.5x - 3.0x）
- 自动续播队列
- 后台播放支持
- 离线下载
- 睡眠定时器
- 播放进度保存

---

**文档说明：**
本文档展示了 WaveCast 应用的核心源代码（前30页部分），包括应用入口、公共工具类、数据模型、播放器服务等关键模块。这些代码构成了应用的基础架构和核心功能实现。

**版权信息：**
- 软件名称：WaveCast
- 版本：1.0.3
- 著作权人：陈云亮
- 开发者：陈云亮
- 联系邮箱：676814828@qq.com
- 包名：com.pangpang.wavecast

---
